<xaiArtifact artifact_id="a7b3e9f2-4c5d-4e1a-9b2f-8d6e5f3c9a1b-final-view" title="index (6)_final_view.html" contentType="text/html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ami's Mind</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* General Styles */
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .app-heading {
            text-align: center; font-size: 2.5rem; font-weight: bold;
            color: #374151; margin-top: 2rem; margin-bottom: 0.5rem;
            background: linear-gradient(to right, #10b981, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card { max-width: 650px; margin: 15px auto; padding: 25px; background-color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .trigger-card { margin-top: 0; }

        /* Input Trigger Styles */
        #inputTrigger {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            background-color: white;
            transition: box-shadow 0.2s ease;
        }
        #inputTrigger:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        #inputTrigger span {
            color: #6b7280;
            margin-right: 16px;
            font-size: 1.25rem;
        }
        #inputTrigger .icon-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        #inputTrigger .icon {
            color: #4b5563;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }
        #inputTrigger .icon:hover {
            color: #10b981;
        }

        /* Form Styles */
        #contentFormWrapper { display: none; }
        .btn { background-color: #10b981; color: white; padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; font-weight: 500; }
        .btn:hover:not(:disabled) { background-color: #059669; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-small { padding: 6px 10px; font-size: 0.875rem; margin-left: 8px;}

        /* Speech Mic Button */
        .mic-btn { background: none; border: none; padding: 5px; cursor: pointer; color: #6b7280; transition: color 0.2s ease; vertical-align: middle; margin-left: 8px; }
        .mic-btn svg { width: 20px; height: 20px; }
        .mic-btn:hover:not(:disabled) { color: #10b981; }
        .mic-btn:disabled { color: #d1d5db; cursor: not-allowed; }
        .mic-btn.pulsing { color: #ef4444; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* Feedback Styles */
        .error { color: #dc3545; font-size: 0.875em; margin-top: 4px; }
        .success { color: #10b981; font-size: 0.875em; margin-top: 4px; }
        .spinner { display: none; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Saved Item Styles */
        .item-card { border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #ffffff; position: relative; }
        .item-content-wrapper { cursor: pointer; }
        .item-img-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
        .item-img { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .item-notes-preview {
            margin: 8px 0; color: #374151; line-height: 1.5;
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4;
           -webkit-box-orient: vertical; text-overflow: ellipsis;
        }
        .item-timestamp { font-size: 0.75em; color: #6b7280; text-align: right; margin-top: 10px; }
        .item-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; background: rgba(255,255,255,0.8); padding: 3px; border-radius: 5px; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 10;}
        .item-card:hover .item-actions { opacity: 1; }
        .item-actions button { background: none; border: none; padding: 4px; cursor: pointer; color: #4b5563; }
        .item-actions button:hover { color: #1f2937; }
        .item-actions svg { width: 18px; height: 18px; }
        .item-actions .pin-btn { color: #f59e0b; }
        .item-actions .pin-btn:hover { color: #d97706; }

        /* Form Input Styles */
        label { font-weight: 600; margin-bottom: 4px; display: block; font-size: 0.875rem; color: #374151; }
        .input-group { position: relative; display: flex; align-items: center; }
        .input-group textarea { flex-grow: 1; }
        input[type="text"], input[type="file"], textarea { border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; width: 100%; margin-top: 4px; transition: border-color 0.3s ease, box-shadow 0.3s ease; line-height: 1.5; }
        input[type="text"]:focus, textarea:focus { border-color: #10b981; outline: none; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        input[type="file"] { padding: 5px; }
        .file-input-style { display: block; width: 100%; text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer border border-gray-300 rounded-md p-2; }
        .form-field { margin-bottom: 1rem; }
        .helper-text { font-size: 0.8em; color: #6b7280; margin-top: 3px; display: block;}

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 30px; border-radius: 8px; max-width: 90%; width: 600px; max-height: 85vh; overflow-y: auto; position: relative; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; color: #6b7280; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: #1f2937; }
        .modal-notes { white-space: pre-wrap; margin-top: 15px; line-height: 1.6; color: #374151; }
        .modal-img-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        .modal-img { max-width: 100%; height: auto; max-height: 400px; object-fit: contain; border-radius: 4px; border: 1px solid #e5e7eb; }

        /* Hide elements */
        .hidden { display: none; }

        #itemsList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .item-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>
</head>
<body>

    <h1 class="app-heading">Ami's Mind</h1>

    <!-- Input Trigger Area -->
    <div class="card trigger-card">
        <div id="inputTrigger">
            <span>Into the Mind...</span>
            <div class="icon-group">
                <svg id="notesIconTrigger" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" title="New Note">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <svg id="pictureIconTrigger" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" title="New Note with Picture">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
        </div>

        <!-- Full Content Form -->
        <div id="contentFormWrapper" class="card -mt-5 border-t pt-5 rounded-t-none shadow-none border-gray-200">
            <form id="contentForm">
                <input type="hidden" id="editItemId" value="">
                <input type="hidden" id="entryMode" value="">

                <div id="picturesFormField" class="form-field hidden">
                    <label id="picturesLabel" for="pictures">Pictures</label>
                    <input type="file" id="pictures" name="pictures" accept="image/*" multiple class="file-input-style">
                    <p id="fileHelper" class="helper-text">Upload one or more images.</p>
                    <div id="existingImages" class="mt-2 item-img-container"></div>
                    <p id="fileError" class="error"></p>
                </div>

                <div class="form-field">
                    <label id="notesLabel" for="notes">Notes:</label>
                    <div class="input-group">
                         <textarea id="notes" name="notes" rows="5"></textarea>
                         <button type="button" id="notesMicBtn" class="mic-btn" title="Record Notes">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                         </button>
                    </div>
                    <p id="notesHelper" class="helper-text">Add your thoughts or details.</p>
                    <p id="notesError" class="error"></p>
                </div>

                <div id="spinner" class="spinner"></div>
                <p id="statusMessage" class="text-center text-sm my-3"></p>
                <div class="flex justify-end gap-3 mt-4">
                     <button type="button" id="cancelButton" class="btn btn-secondary">Cancel</button>
                     <button type="submit" id="submitBtn" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Saved Items Area -->
    <div class="card">
        <h2 class="text-xl font-bold text-center mb-5 text-gray-700">Saved Items</h2>
        <input type="text" id="searchBar" class="w-full p-2 border border-gray-300 rounded-md mb-5 shadow-sm" placeholder="Search notes...">
        <div id="itemsList">
            <p id="loadingMessage" class="text-center text-gray-500 mt-4">Loading items...</p>
        </div>
    </div>

    <!-- Item View Modal -->
    <div id="viewModalOverlay" class="modal-overlay">
        <div id="viewModalContent" class="modal-content">
            <button id="viewModalCloseBtn" class="modal-close-btn" title="Close">&times;</button>
            <div id="modalImageContainer" class="modal-img-container"></div>
            <div id="modalNotesContent" class="modal-notes"></div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBq3ND6irGFsZYgl95Atf5gm62sFcW-R_Y",
        authDomain: "amis-s-mind.firebaseapp.com",
        databaseURL: "https://amis-s-mind-default-rtdb.firebaseio.com",
        projectId: "amis-s-mind",
        storageBucket: "amis-s-mind.firebasestorage.app",
        messagingSenderId: "759504870947",
        appId: "1:759504870947:web:4036e4989edd10a7dcdb96",
        measurementId: "G-EZFTKMB4Z6"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Firebase initialization error:", e);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();

    const MAX_FILE_SIZE_MB = 10;
    const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
    const NOTE_PREVIEW_LENGTH = 150;

    const inputTrigger = document.getElementById('inputTrigger');
    const notesIconTrigger = document.getElementById('notesIconTrigger');
    const pictureIconTrigger = document.getElementById('pictureIconTrigger');
    const contentFormWrapper = document.getElementById('contentFormWrapper');
    const contentForm = document.getElementById('contentForm');
    const picturesFormField = document.getElementById('picturesFormField');
    const picturesLabel = document.getElementById('picturesLabel');
    const picturesInput = document.getElementById('pictures');
    const notesLabel = document.getElementById('notesLabel');
    const notesTextarea = document.getElementById('notes');
    const notesMicBtn = document.getElementById('notesMicBtn');
    const spinner = document.getElementById('spinner');
    const statusMessage = document.getElementById('statusMessage');
    const submitButton = document.getElementById('submitBtn');
    const cancelButton = document.getElementById('cancelButton');
    const editItemIdInput = document.getElementById('editItemId');
    const entryModeInput = document.getElementById('entryMode');
    const existingImagesDiv = document.getElementById('existingImages');
    const fileError = document.getElementById('fileError');
    const notesError = document.getElementById('notesError');
    const itemsList = document.getElementById('itemsList');
    const searchBar = document.getElementById('searchBar');
    const loadingMessage = document.getElementById('loadingMessage');
    const fileHelper = document.getElementById('fileHelper');
    const notesHelper = document.getElementById('notesHelper');
    const viewModalOverlay = document.getElementById('viewModalOverlay');
    const viewModalContent = document.getElementById('viewModalContent');
    const viewModalCloseBtn = document.getElementById('viewModalCloseBtn');
    const modalImageContainer = document.getElementById('modalImageContainer');
    const modalNotesContent = document.getElementById('modalNotesContent');

    notesIconTrigger.addEventListener('click', (e) => { e.stopPropagation(); openForm('notes'); });
    pictureIconTrigger.addEventListener('click', (e) => { e.stopPropagation(); openForm('picture'); });
    inputTrigger.addEventListener('click', () => { if (contentFormWrapper.style.display === 'none') openForm('notes'); });

    function openForm(mode) {
        resetForm(false);
        entryModeInput.value = mode;

        if (mode === 'notes') {
            notesLabel.textContent = 'Notes:';
            notesHelper.textContent = 'Add your thoughts or details.';
            picturesFormField.classList.add('hidden');
        } else if (mode === 'picture') {
            notesLabel.textContent = 'Notes (optional):';
            notesHelper.textContent = 'Add optional notes for the picture.';
            picturesFormField.classList.remove('hidden');
            picturesLabel.textContent = 'Pictures (Required):';
            fileHelper.textContent = 'Upload one or more images (Required).';
        } else if (mode === 'edit') {
             notesLabel.textContent = 'Notes:';
             notesHelper.textContent = 'Edit your notes.';
        }

        contentFormWrapper.style.display = 'block';
        inputTrigger.style.display = 'none';
        notesTextarea.focus();
    }

    cancelButton.addEventListener('click', closeForm);

    function closeForm() {
        contentFormWrapper.style.display = 'none';
        inputTrigger.style.display = 'flex';
        resetForm(false);
    }

    function resetForm(focusNotes = false) {
        stopSpeechRecognition();
        contentForm.reset();
        editItemIdInput.value = '';
        entryModeInput.value = '';
        submitButton.textContent = 'Save';
        submitButton.disabled = false;
        cancelButton.disabled = false;
        spinner.style.display = 'none';
        setStatusMessage('', false);
        fileError.textContent = '';
        notesError.textContent = '';
        existingImagesDiv.innerHTML = '';
        picturesInput.value = null;
        picturesInput.disabled = false;
        picturesFormField.classList.add('hidden');
        notesLabel.textContent = 'Notes:';
        picturesLabel.textContent = 'Pictures:';
        notesHelper.textContent = 'Add your thoughts or details.';
        fileHelper.textContent = 'Upload one or more images.';
        if (focusNotes) notesTextarea.focus();
    }

    function setStatusMessage(message, isSuccess) {
        statusMessage.textContent = message;
        statusMessage.classList.remove('error', 'success');
        statusMessage.classList.add(isSuccess ? 'success' : 'error');
        if (message && isSuccess) setTimeout(() => statusMessage.textContent = '', 3000);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let notesRecognition = null;
    let activeRecognition = null;
    let activeMicButton = null;

    function setupSpeechRecognitionInstance(textarea, micButton) {
        try {
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    }
                }
                textarea.value += (textarea.value.length > 0 ? ' ' : '') + transcript.trim();
                console.log('Speech recognition result:', transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                alert(`Speech recognition error: ${event.error}. Please try again.`);
                stopSpeechRecognition();
            };

            recognition.onstart = () => {
                console.log('Speech recognition started.');
                micButton.classList.add('pulsing');
                activeRecognition = recognition;
                activeMicButton = micButton;
            };

            recognition.onend = () => {
                console.log('Speech recognition stopped.');
                if (activeRecognition === recognition) {
                    micButton.classList.remove('pulsing');
                    activeRecognition = null;
                    activeMicButton = null;
                }
            };

            return recognition;
        } catch (error) {
            console.error('Error initializing SpeechRecognition:', error);
            alert('Speech recognition is not supported in your browser.');
            micButton.style.display = 'none';
            textarea.placeholder = "Speech recognition is not supported in your browser.";
            return null;
        }
    }

    function stopSpeechRecognition() {
        if (activeRecognition) {
            activeRecognition.stop();
            console.log('Speech recognition stopped manually.');
        } else if (activeMicButton) {
            activeMicButton.classList.remove('pulsing');
        }
        activeRecognition = null;
        activeMicButton = null;
    }

    if (SpeechRecognition) {
        notesRecognition = setupSpeechRecognitionInstance(notesTextarea, notesMicBtn);
        if (notesRecognition) {
            notesMicBtn.addEventListener('click', () => {
                if (activeRecognition === notesRecognition) {
                    stopSpeechRecognition();
                    notesMicBtn.classList.remove('pulsing');
                } else {
                    stopSpeechRecognition();
                    try {
                        notesRecognition.start();
                        notesMicBtn.classList.add('pulsing');
                    } catch (e) {
                        console.error("Error starting speech recognition:", e);
                        alert("Could not start speech recognition. Please ensure your microphone is enabled.");
                    }
                }
            });
        }
    } else {
        console.warn('Speech recognition not supported in this browser.');
        notesMicBtn.style.display = 'none';
        notesTextarea.placeholder = "Speech recognition is not supported in your browser.";
    }

    let allItems = [];
    const unsubscribe = db.collection('pictures')
        .orderBy('timestamp', 'desc')
        .onSnapshot(
            (snapshot) => {
                loadingMessage.style.display = 'none';
                allItems = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : null
                }));
                console.log("Fetched items:", allItems); // Debug data
                displayItems();
            },
            (error) => {
                console.error("Error fetching items from Firestore:", error);
                loadingMessage.textContent = "Failed to load items. Please try again later.";
            }
        );

    function displayItems() {
        const searchTerm = searchBar.value.toLowerCase().trim();

        const pinnedItems = allItems.filter(item => item.pinned).sort((a, b) => b.timestamp - a.timestamp);
        const unpinnedItems = allItems.filter(item => !item.pinned).sort((a, b) => b.timestamp - a.timestamp);

        const filteredPinnedItems = pinnedItems.filter(item => {
            const notes = (item.notes || '').toLowerCase();
            const timestampString = item.timestamp ? item.timestamp.toLocaleString() : '';
            return notes.includes(searchTerm) || timestampString.includes(searchTerm);
        });

        const filteredUnpinnedItems = unpinnedItems.filter(item => {
            const notes = (item.notes || '').toLowerCase();
            const timestampString = item.timestamp ? item.timestamp.toLocaleString() : '';
            return notes.includes(searchTerm) || timestampString.includes(searchTerm);
        });

        itemsList.innerHTML = '';

        if (allItems.length === 0 && loadingMessage.style.display === 'none') {
            itemsList.innerHTML = '<p class="text-center text-gray-500">No items saved yet.</p>';
        } else if (filteredPinnedItems.length === 0 && filteredUnpinnedItems.length === 0) {
            itemsList.innerHTML = '<p class="text-center text-gray-500">No items match your search.</p>';
        }

        filteredPinnedItems.forEach(item => renderItem(item, true));
        filteredUnpinnedItems.forEach(item => renderItem(item, false));
    }

    function renderItem(item, isPinned) {
        const itemElement = document.createElement('div');
        itemElement.className = 'item-card';
        itemElement.setAttribute('data-id', item.id);

        let imagesHtmlPreview = '';
        if (Array.isArray(item.pictureUrls) && item.pictureUrls.length > 0) {
            imagesHtmlPreview = `<div class="item-img-container">
                                   <img src="${item.pictureUrls[0]}" alt="Preview" class="item-img">
                                 </div>`;
        }

        const timestampStr = item.timestamp ? item.timestamp.toLocaleString() : 'Unknown time';
        const notesPreview = item.notes ? escapeHtml(item.notes) : 'No notes'; // Fixed undefined issue

        itemElement.innerHTML = `
            <div class="item-actions">
                <button class="pin-btn" title="${isPinned ? 'Unpin Item' : 'Pin Item'}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isPinned ? 'M5 15l7-7 7 7' : 'M12 19V6m0 0l-7 7m7-7l7 7'}" />
                    </svg>
                </button>
                <button class="edit-btn" title="Edit Item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </button>
                <button class="delete-btn" title="Delete Item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
            <div class="item-content-wrapper" data-id="${item.id}">
                ${imagesHtmlPreview}
                <p class="item-notes-preview">${notesPreview}</p>
                <p class="item-timestamp">${timestampStr}</p>
            </div>
        `;
        itemsList.appendChild(itemElement);
    }

    itemsList.addEventListener('click', (e) => {
        const pinButton = e.target.closest('.pin-btn');
        const editButton = e.target.closest('.edit-btn');
        const deleteButton = e.target.closest('.delete-btn');
        const viewTrigger = e.target.closest('.item-content-wrapper');

        if (pinButton) {
            const itemId = pinButton.closest('.item-card')?.dataset.id;
            if (itemId) handlePinClick(itemId);
        } else if (editButton) {
            console.log("Edit button clicked"); // Debug
            const itemId = editButton.closest('.item-card')?.dataset.id;
            if (itemId) handleEditClick(itemId);
        } else if (deleteButton) {
            console.log("Delete button clicked"); // Debug
            const itemId = deleteButton.closest('.item-card')?.dataset.id;
            if (itemId) handleDeleteClick(itemId);
        } else if (viewTrigger) {
            if (!e.target.closest('.item-actions')) {
                const itemId = viewTrigger.dataset.id;
                if (itemId) handleViewClick(itemId);
            }
        }
    });

    async function handlePinClick(itemId) {
        try {
            const item = allItems.find(item => item.id === itemId);
            if (!item) return;

            const newPinnedStatus = !item.pinned;
            await db.collection('pictures').doc(itemId).update({ pinned: newPinnedStatus });
            setStatusMessage(newPinnedStatus ? 'Item pinned!' : 'Item unpinned!', true);
        } catch (error) {
            console.error('Error updating pin status:', error);
            setStatusMessage('Failed to update pin status.', false);
        }
    }

    function escapeHtml(unsafe) {
        if (unsafe === undefined || unsafe === null) return ''; // Fixed undefined handling
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    searchBar.addEventListener('input', displayItems);

    function handleViewClick(itemId) {
        const itemToView = allItems.find(item => item.id === itemId);
        if (!itemToView) return;

        modalNotesContent.innerHTML = escapeHtml(itemToView.notes || "").replace(/\n/g, '<br>');

        modalImageContainer.innerHTML = '';
        if (Array.isArray(itemToView.pictureUrls) && itemToView.pictureUrls.length > 0) {
            itemToView.pictureUrls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = "Saved Image";
                img.className = "modal-img";
                modalImageContainer.appendChild(img);
            });
        }

        viewModalOverlay.classList.add('active');
    }

    viewModalCloseBtn.addEventListener('click', closeViewModal);
    viewModalOverlay.addEventListener('click', (e) => {
        if (e.target === viewModalOverlay) {
            closeViewModal();
        }
    });

    function closeViewModal() {
        viewModalOverlay.classList.remove('active');
    }

    function handleEditClick(itemId) {
        const itemToEdit = allItems.find(item => item.id === itemId);
        if (!itemToEdit) return;

        resetForm(false);
        editItemIdInput.value = itemId;
        entryModeInput.value = 'edit';
        notesTextarea.value = itemToEdit.notes || '';

        if (Array.isArray(itemToEdit.pictureUrls) && itemToEdit.pictureUrls.length > 0) {
            picturesFormField.classList.remove('hidden');
            picturesLabel.textContent = 'Pictures (Optional):';
            fileHelper.textContent = 'Upload new images to replace existing ones (optional).';
            itemToEdit.pictureUrls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Existing Image';
                img.className = 'item-img';
                existingImagesDiv.appendChild(img);
            });
            picturesInput.disabled = false;
        } else {
            picturesFormField.classList.add('hidden');
        }

        submitButton.textContent = 'Update';
        contentFormWrapper.style.display = 'block';
        inputTrigger.style.display = 'none';
        notesTextarea.focus();
    }

    async function handleDeleteClick(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        showSpinner('Deleting...');
        try {
            const item = allItems.find(item => item.id === itemId);
            if (item && Array.isArray(item.pictureUrls)) {
                const deletePromises = item.pictureUrls.map(url => {
                    const fileRef = storage.refFromURL(url);
                    return fileRef.delete().catch(error => {
                        console.error('Error deleting file:', error);
                    });
                });
                await Promise.all(deletePromises);
            }

            await db.collection('pictures').doc(itemId).delete();
            setStatusMessage('Item deleted successfully!', true);
        } catch (error) {
            console.error('Error deleting item:', error);
            setStatusMessage('Failed to delete item.', false);
        } finally {
            hideSpinner();
        }
    }

    function showSpinner(message = 'Processing...') {
        spinner.style.display = 'block';
        setStatusMessage(message, false);
    }

    function hideSpinner() {
        spinner.style.display = 'none';
    }

    contentForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        stopSpeechRecognition();

        const editingItemId = editItemIdInput.value;
        const isEditing = !!editingItemId;
        const notes = notesTextarea.value.trim();
        const files = picturesInput.files;

        fileError.textContent = '';
        notesError.textContent = '';
        setStatusMessage('', false);

        let isValid = true;
        let pictureUrls = [];
        let hasFilesToUpload = files.length > 0;

        if (!notes) {
            notesError.textContent = 'Please enter some notes.';
            isValid = false;
        }

        if (!isEditing && hasFilesToUpload) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    fileError.textContent = 'Please upload image files only.';
                    isValid = false;
                    break;
                }
                if (file.size > MAX_FILE_SIZE_BYTES) {
                    fileError.textContent = `Each file must be less than ${MAX_FILE_SIZE_MB} MB.`;
                    isValid = false;
                    break;
                }
            }
        } else if (isEditing) {
            const currentItem = allItems.find(item => item.id === editingItemId);
            pictureUrls = currentItem?.pictureUrls || [];
            hasFilesToUpload = false;
        }

        if (!isValid) return;

        showSpinner(isEditing ? 'Updating...' : 'Saving...');
        submitButton.disabled = true;
        cancelButton.disabled = true;

        try {
            if (!isEditing && hasFilesToUpload) {
                setStatusMessage('Uploading pictures...', false);
                const uploadPromises = Array.from(files).map(file => {
                    const filePath = `pictures/${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    const storageRef = storage.ref(filePath);
                    const uploadTask = storageRef.put(file);
                    return new Promise((resolve, reject) => {
                        uploadTask.on(
                            'state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                setStatusMessage(`Uploading ${file.name}: ${Math.round(progress)}%`, false);
                            },
                            reject,
                            async () => {
                                try {
                                    resolve(await uploadTask.snapshot.ref.getDownloadURL());
                                } catch (urlError) {
                                    reject(urlError);
                                }
                            }
                        );
                    });
                });
                pictureUrls = await Promise.all(uploadPromises);
            }

            setStatusMessage(isEditing ? 'Updating data...' : 'Saving data...', false);
            if (isEditing) {
                await db.collection('pictures').doc(editingItemId).update({ notes: notes });
                setStatusMessage('Updated successfully!', true);
            } else {
                await db.collection('pictures').add({
                    notes: notes,
                    pictureUrls: pictureUrls,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    pinned: false
                });
                setStatusMessage("Saved in Ami's Mind", true); // Updated success message
            }
            setTimeout(closeForm, 1500);
        } catch (error) {
            console.error('Error saving/updating item:', error);
            setStatusMessage(`Failed to ${isEditing ? 'update' : 'save'} item.`, false);
            submitButton.disabled = false;
            cancelButton.disabled = false;
        } finally {
            hideSpinner();
            if (!statusMessage.classList.contains('success')) {
                submitButton.disabled = false;
                cancelButton.disabled = false;
            }
        }
    });
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92717fed1cb5e5f0',t:'MTc0MzEwNTg5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
</xaiArtifact>
